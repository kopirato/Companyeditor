<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Selelo Media Studio</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');

        body {
            margin: 0;
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #020617, #0f172a);
            color: #f8fafc;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }

        .app {
            max-width: 520px;
            margin: auto;
            padding: 40px 20px;
            background: rgba(2, 6, 23, 0.8);
            border-radius: 24px;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            transition: transform 0.3s ease;
        }

        .app:hover {
            transform: translateY(-5px);
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 28px;
            color: #38bdf8;
            font-weight: 700;
            letter-spacing: -0.5px;
        }

        .header p {
            color: #94a3b8;
            font-size: 15px;
            font-weight: 400;
        }

        .panel {
            background: #020617;
            border: 1px solid #0f172a;
            border-radius: 16px;
            padding: 25px;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.7);
        }

        input[type="file"] {
            width: 100%;
            background: #020617;
            border: 1px dashed #334155;
            color: #f8fafc;
            padding: 16px;
            border-radius: 12px;
            cursor: pointer;
            transition: border-color 0.3s ease, background 0.3s ease;
        }

        input[type="file"]:hover {
            border-color: #38bdf8;
            background: #0f172a;
        }

        .preview {
            margin-top: 25px;
            text-align: center;
            position: relative;
        }

        canvas, video {
            width: 100%;
            border-radius: 12px;
            margin-top: 15px;
            display: none;
            background: black;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            transition: opacity 0.5s ease;
        }

        .controls {
            margin-top: 25px;
        }

        button {
            width: 100%;
            background: linear-gradient(135deg, #38bdf8, #0284c7);
            border: none;
            color: #020617;
            padding: 16px;
            border-radius: 12px;
            font-weight: 700;
            font-size: 16px;
            cursor: pointer;
            transition: background 0.3s ease, transform 0.2s ease;
        }

        button:hover {
            background: linear-gradient(135deg, #0ea5e9, #0369a1);
            transform: translateY(-2px);
        }

        button:disabled {
            background: #334155;
            color: #94a3b8;
            cursor: not-allowed;
            transform: none;
        }

        #status {
            text-align: center;
            margin-top: 15px;
            font-size: 14px;
            color: #94a3b8;
            transition: color 0.3s ease;
        }

        #status.success {
            color: #22c55e;
        }
    </style>
</head>

<body>

<div class="app">

    <div class="header">
        <h1>Selelo Corporate Media Studio</h1>
        <p>Upload images or videos → Enhance → Logo → Download</p>
    </div>

    <div class="panel">
        <input type="file" id="upload" accept="image/*,video/*">

        <div class="preview">
            <canvas id="canvas"></canvas>
            <video id="video" controls></video>
        </div>

        <div class="controls">
            <button id="download" disabled>Download Branded Media</button>
        </div>

        <p id="status"></p>
    </div>
</div>

<script>
const upload = document.getElementById("upload");
const canvas = document.getElementById("canvas");
const videoElem = document.getElementById("video");
const ctx = canvas.getContext("2d");
const downloadBtn = document.getElementById("download");
const status = document.getElementById("status");

let finalBlob = null;
let currentType = null;

// Load logo
const logo = new Image();
logo.src = "11.png"; // Your logo file
logo.onload = () => console.log("Logo loaded");
logo.onerror = () => alert("Missing: 11.png in repo root");

// Upload handler
upload.addEventListener("change", e => {
    const file = e.target.files[0];
    if (!file) return;

    downloadBtn.disabled = true;
    finalBlob = null;
    status.textContent = "Processing...";

    if (file.type.startsWith("image")) {
        currentType = "image";
        processImage(file);
    } else if (file.type.startsWith("video")) {
        currentType = "video";
        processVideo(file);
    } else {
        alert("Unsupported file type");
    }
});

// HSL conversion helpers
function rgbToHsl(r, g, b) {
    r /= 255; g /= 255; b /= 255;
    const max = Math.max(r, g, b), min = Math.min(r, g, b);
    let h, s, l = (max + min) / 2;
    if (max === min) {
        h = s = 0;
    } else {
        const d = max - min;
        s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
        switch (max) {
            case r: h = (g - b) / d + (g < b ? 6 : 0); break;
            case g: h = (b - r) / d + 2; break;
            case b: h = (r - g) / d + 4; break;
        }
        h /= 6;
    }
    return [h, s, l];
}

function hslToRgb(h, s, l) {
    let r, g, b;
    if (s === 0) {
        r = g = b = l;
    } else {
        const hue2rgb = (p, q, t) => {
            if (t < 0) t += 1;
            if (t > 1) t -= 1;
            if (t < 1/6) return p + (q - p) * 6 * t;
            if (t < 1/2) return q;
            if (t < 2/3) return p + (q - p) * (2/3 - t) * 6;
            return p;
        };
        const q = l < 0.5 ? l * (1 + s) : l + s - l * s;
        const p = 2 * l - q;
        r = hue2rgb(p, q, h + 1/3);
        g = hue2rgb(p, q, h);
        b = hue2rgb(p, q, h - 1/3);
    }
    return [Math.round(r * 255), Math.round(g * 255), Math.round(b * 255)];
}

// Enhanced color grading (Baraka-inspired: vibrant, natural, high contrast)
function enhanceFrame(ctx, width, height) {
    const imgData = ctx.getImageData(0, 0, width, height);
    const d = imgData.data;
    for (let i = 0; i < d.length; i += 4) {
        let [h, s, l] = rgbToHsl(d[i], d[i+1], d[i+2]);
        
        // Brightness and vibrancy boost
        l = Math.min(1, Math.max(0, l * 1.04));
        
        // S-curve contrast for cinematic depth
        l = 3 * l * l - 2 * l * l * l;
        l = Math.min(1, Math.max(0, l * 1.12));
        
        // Saturation for rich tones, subtle hue shift for warmth
        s = Math.min(1, s * 1.08);
        h = (h + 0.015) % 1; // Warm shift inspired by Baraka's golden hours
        
        const [r, g, b] = hslToRgb(h, s, l);
        d[i] = r; d[i+1] = g; d[i+2] = b;
    }
    ctx.putImageData(imgData, 0, 0);
    
    // Final polish with filter (vignette-like)
    ctx.filter = 'brightness(1.02) contrast(1.05) saturate(1.08)';
    ctx.drawImage(ctx.canvas, 0, 0);
    ctx.filter = 'none';
}

// Sharpening for crisp details
function sharpenFrame(ctx, width, height) {
    const imgData = ctx.getImageData(0, 0, width, height);
    const d = imgData.data;
    const kernel = [0, -1, 0, -1, 5, -1, 0, -1, 0];
    const side = 3, half = Math.floor(side / 2);
    
    for (let y = half; y < height - half; y++) {
        for (let x = half; x < width - half; x++) {
            let r = 0, g = 0, b = 0;
            for (let ky = 0; ky < side; ky++) {
                for (let kx = 0; kx < side; kx++) {
                    const px = ((y + ky - half) * width + (x + kx - half)) * 4;
                    const weight = kernel[ky * side + kx];
                    r += d[px] * weight;
                    g += d[px + 1] * weight;
                    b += d[px + 2] * weight;
                }
            }
            const idx = (y * width + x) * 4;
            d[idx] = clamp(r);
            d[idx + 1] = clamp(g);
            d[idx + 2] = clamp(b);
        }
    }
    ctx.putImageData(imgData, 0, 0);
}

// Advanced logo blending
function addLogoToFrame(ctx, width, height) {
    const scale = width * 0.12 / logo.width;
    const w = logo.width * scale;
    const h = logo.height * scale;
    const x = width - w - 30;
    const y = height - h - 30;
    
    ctx.save();
    ctx.filter = 'drop-shadow(4px 4px 8px rgba(0,0,0,0.5))';
    ctx.globalCompositeOperation = 'soft-light';
    ctx.globalAlpha = 0.75;
    ctx.drawImage(logo, x, y, w, h);
    ctx.restore();
}

// Image processing
function processImage(file) {
    videoElem.style.display = "none";
    canvas.style.display = "block";

    const img = new Image();
    img.onload = () => {
        const upscaleFactor = 2;
        canvas.width = img.width * upscaleFactor;
        canvas.height = img.height * upscaleFactor;

        // Use OffscreenCanvas if available for better performance
        const processingCanvas = 'OffscreenCanvas' in window ? new OffscreenCanvas(canvas.width, canvas.height) : canvas;
        const pCtx = processingCanvas.getContext('2d');
        pCtx.imageSmoothingEnabled = true;
        pCtx.imageSmoothingQuality = 'high';

        // Multi-step upscale for smoothness
        pCtx.drawImage(img, 0, 0, img.width, img.height);
        pCtx.drawImage(processingCanvas, 0, 0, img.width, img.height, 0, 0, canvas.width, canvas.height);

        enhanceFrame(pCtx, canvas.width, canvas.height);
        sharpenFrame(pCtx, canvas.width, canvas.height);
        addLogoToFrame(pCtx, canvas.width, canvas.height);

        if (processingCanvas instanceof OffscreenCanvas) {
            const bitmap = processingCanvas.transferToImageBitmap();
            ctx.drawImage(bitmap, 0, 0);
        }

        canvas.toBlob(blob => {
            finalBlob = blob;
            downloadBtn.disabled = false;
            status.textContent = "Image ready (Cinematic HD) ✅";
            status.classList.add('success');
        }, "image/png", 1.0);
    };
    img.src = URL.createObjectURL(file);
}

// Video processing (frame-by-frame enhancement and export)
async function processVideo(file) {
    canvas.style.display = "none";
    videoElem.style.display = "block";
    const url = URL.createObjectURL(file);
    videoElem.src = url;
    videoElem.load();

    videoElem.onloadedmetadata = async () => {
        const tempCanvas = document.createElement('canvas');
        const tempCtx = tempCanvas.getContext('2d');
        tempCanvas.width = videoElem.videoWidth * 1.5; // 1.5x upscale for quality
        tempCanvas.height = videoElem.videoHeight * 1.5;

        const stream = tempCanvas.captureStream(30); // Assume 30fps
        const recorder = new MediaRecorder(stream, { mimeType: 'video/webm;codecs=vp9' });
        const chunks = [];

        recorder.ondataavailable = e => chunks.push(e.data);
        recorder.onstop = () => {
            finalBlob = new Blob(chunks, { type: 'video/mp4' });
            downloadBtn.disabled = false;
            status.textContent = "Video ready (Cinematic Quality) ✅";
            status.classList.add('success');
        };

        recorder.start();

        let currentTime = 0;
        const duration = videoElem.duration;
        const frameRate = 30; // Target fps
        const frameDuration = 1 / frameRate;

        while (currentTime < duration) {
            videoElem.currentTime = currentTime;
            await new Promise(resolve => videoElem.onseeked = resolve);

            tempCtx.drawImage(videoElem, 0, 0, tempCanvas.width, tempCanvas.height);
            enhanceFrame(tempCtx, tempCanvas.width, tempCanvas.height);
            sharpenFrame(tempCtx, tempCanvas.width, tempCanvas.height);
            addLogoToFrame(tempCtx, tempCanvas.width, tempCanvas.height);

            currentTime += frameDuration;
        }

        recorder.stop();
    };
}

// Download handler
downloadBtn.addEventListener("click", () => {
    if (!finalBlob) return;
    const url = URL.createObjectURL(finalBlob);
    const a = document.createElement("a");
    a.href = url;
    a.download = currentType === "image" ? "selelo_branded.png" : "selelo_branded.mp4";
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
});

function clamp(v) { return Math.max(0, Math.min(255, v)); }
</script>
</body>
</html>
